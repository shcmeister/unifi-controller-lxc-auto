#!/bin/bash

set -e

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
CTID=200
HOSTNAME="unifi-lxc"
PASSWORD="YourSecurePass123"  # –°–º–µ–Ω–∏ –ø–∞—Ä–æ–ª–∞—Ç–∞
TEMPLATE="debian-12-standard_12.7-1_amd64.tar.zst"
CORES=2
MEMORY=4096
DISK=18  # GB

# –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Å—Ç–æ—Ä–∏–¥–∂ —Å –Ω–∞–π-–º–Ω–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ –º—è—Å—Ç–æ
select_storage() {
    echo "‚ÑπÔ∏è –ù–∞–ª–∏—á–Ω–∏ —Å—Ç–æ—Ä–∏–¥–∂–∏ —Å —Ä–∞–∑–º–µ—Ä –∏ —Å–≤–æ–±–æ–¥–Ω–æ –º—è—Å—Ç–æ:"
    # –ò–∑–≤–ª–∏—á–∞–º–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Å—Ç–æ—Ä–∏–¥–∂–æ–≤–µ—Ç–µ, —Ñ–∏–ª—Ç—Ä–∏—Ä–∞–º–µ local –∏ Fuji*
    pvesm status | grep -E 'local|Fuji' | awk '{print $1, $2, $4, $5}' | while read st name total free; do
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–≤–∞–º–µ —Å–≤–æ–±–æ–¥–Ω–æ—Ç–æ –º—è—Å—Ç–æ –≤ GB (–∞–∫–æ –µ –≤ TB –∏–ª–∏ MB)
        size=$free
        if [[ $free == *"TB" ]]; then
            size=$(echo "$free" | sed 's/TB//' | awk '{print $1*1024}')
        elif [[ $free == *"MB" ]]; then
            size=$(echo "$free" | sed 's/MB//' | awk '{print $1/1024}')
        else
            size=$(echo "$free" | sed 's/GB//')
        fi
        echo "$size $st"
    done | sort -nr | head -n1 | awk '{print $2}'
}

echo "üõ†Ô∏è –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Å–∫—Ä–∏–ø—Ç –∑–∞ UniFi LXC..."

# –ò–∑–±–æ—Ä –Ω–∞ —Å—Ç–æ—Ä–∏–¥–∂ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
ROOTFS_STORAGE=$(select_storage)
echo "‚úÖ –ò–∑–±—Ä–∞–Ω —Å—Ç–æ—Ä–∏–¥–∂ —Å –Ω–∞–π-–º–Ω–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ –º—è—Å—Ç–æ: $ROOTFS_STORAGE"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —à–∞–±–ª–æ–Ω—ä—Ç –µ –Ω–∞–ª–∏—á–µ–Ω
echo "‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –¥–∞–ª–∏ —à–∞–±–ª–æ–Ω—ä—Ç $TEMPLATE –µ –Ω–∞–ª–∏—á–µ–Ω –≤ —Å—Ç–æ—Ä–∏–¥–∂ $ROOTFS_STORAGE..."
if ! pveam list $ROOTFS_STORAGE | grep -q "$TEMPLATE"; then
    echo "‚ÑπÔ∏è –®–∞–±–ª–æ–Ω—ä—Ç –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω. –°–≤–∞–ª—è–º..."
    pveam download $ROOTFS_STORAGE $TEMPLATE || { echo "‚ùå ERROR: –ù–µ—É—Å–ø–µ—à–Ω–æ —Å–≤–∞–ª—è–Ω–µ –Ω–∞ —à–∞–±–ª–æ–Ω–∞!"; exit 1; }
else
    echo "‚úÖ –®–∞–±–ª–æ–Ω—ä—Ç –≤–µ—á–µ –µ –Ω–∞–ª–∏—á–µ–Ω."
fi

# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
echo "üöÄ –°—ä–∑–¥–∞–≤–∞–º LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CTID..."
pct create $CTID $ROOTFS_STORAGE:vztmpl/$TEMPLATE \
    --hostname $HOSTNAME \
    --cores $CORES \
    --memory $MEMORY \
    --rootfs $ROOTFS_STORAGE:${DISK} \
    --password $PASSWORD \
    --features nesting=1 \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --ostype debian

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ–Ω —Å—Ç–∞—Ä—Ç –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ boot
pct set $CTID --onboot 1

# –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo "‚ö° –°—Ç–∞—Ä—Ç–∏—Ä–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
pct start $CTID

# –ò–∑—á–∞–∫–≤–∞–º–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∞ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∏ –¥–∞ –ø–æ–ª—É—á–∏ IP
echo "‚è≥ –ò–∑—á–∞–∫–≤–∞–º–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∞ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∏ –¥–∞ –ø–æ–ª—É—á–∏ IP –∞–¥—Ä–µ—Å..."
sleep 15

# –í–∑–∏–º–∞–º–µ IP-—Ç–æ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
CONTAINER_IP=$(pct exec $CTID ip a show eth0 | grep 'inet ' | awk '{print $2}' | cut -d/ -f1)
if [ -z "$CONTAINER_IP" ]; then
    echo "‚ùå –ù–µ—É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞–≤–∞–Ω–µ –Ω–∞ IP –∞–¥—Ä–µ—Å–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä–∏ DHCP –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞."
else
    echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ä—Ç –µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω. IP –∞–¥—Ä–µ—Å: $CONTAINER_IP"
fi

# –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ UniFi Controller –≤—ä—Ç—Ä–µ –≤ LXC-—Ç–æ
echo "üì¶ –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–º UniFi Controller –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

pct exec $CTID bash -c "
apt-get update && apt-get install -y curl gnupg apt-transport-https openjdk-17-jre-headless wget lsb-release ca-certificates &&
wget -qO - https://dl.ui.com/unifi/unifi-repo.gpg | apt-key add - &&
echo 'deb https://dl.ui.com/unifi/debian stable ubiquiti' > /etc/apt/sources.list.d/100-ubnt-unifi.list &&
apt-get update &&
apt-get install -y unifi
"

echo -e "\nüéâ \033[1;32mUniFi Controller –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!\033[0m"
echo -e "üåê –û—Ç–≤–æ—Ä–∏ –≤ –±—Ä–∞—É–∑—ä—Ä: \033[1;36mhttps://$CONTAINER_IP:8443\033[0m"
echo -e "üî• –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ä—Ç —â–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç –Ω–∞ Proxmox."

exit 0
