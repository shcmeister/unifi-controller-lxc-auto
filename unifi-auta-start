#!/usr/bin/env bash

# ==============================================
# Автоматична инсталация на UniFi Controller в LXC
# Стабилна версия без грешки
# ==============================================

# Проверка за root
if [ "$(id -u)" -ne 0 ]; then
  echo "Този скрипт трябва да се изпълнява като root!"
  exit 1
fi

# Проверка за Proxmox VE
if ! command -v pct >/dev/null 2>&1; then
  echo "Този скрипт е предназначен за Proxmox VE!"
  exit 1
fi

# Конфигурация
CTID=$(pvesh get /cluster/nextid)
HOSTNAME="unifi"
PASSWORD=$(openssl rand -base64 12)
MEMORY=2048
SWAP=512
DISK_SIZE="8G"
CORES=2

# Функция за избор на storage
select_storage() {
  clear
  echo "Налични storage устройства:"
  echo "--------------------------"
  
  # Използваме само pvesm status за изброяване
  STORAGE_LIST=$(pvesm status | awk 'NR>1 {print $1}')
  echo "$STORAGE_LIST"
  echo "--------------------------"
  
  while true; do
    read -p "Моля изберете storage устройство: " STORAGE
    if echo "$STORAGE_LIST" | grep -q "^$STORAGE$"; then
      break
    else
      echo "Грешка: '$STORAGE' не е валиден storage. Опитайте отново."
    fi
  done
}

# Създаване на контейнер
create_container() {
  echo "Създаване на LXC контейнер..."
  pct create $CTID \
    -storage "$STORAGE" \
    -hostname "$HOSTNAME" \
    -password "$PASSWORD" \
    -memory $MEMORY \
    -swap $SWAP \
    -cores $CORES \
    -net0 name=eth0,bridge=vmbr0,ip=dhcp \
    -unprivileged 1 \
    -features nesting=1 \
    -ostype debian \
    -rootfs "$STORAGE:$DISK_SIZE"

  pct start $CTID
  sleep 5
}

# Инсталация на UniFi
install_unifi() {
  echo "Инсталиране на UniFi Controller..."
  pct exec $CTID -- bash -c '
    apt-get update && apt-get install -y wget
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/mongodb-archive-keyring.gpg] http://repo.mongodb.org/apt/debian buster/mongodb-org/4.4 main" > /etc/apt/sources.list.d/mongodb-org.list
    wget -qO - https://www.ui.com/downloads/unifi/debian/unifi-repo.gpg | gpg --dearmor -o /usr/share/keyrings/unifi-repo.gpg
    echo "deb [signed-by=/usr/share/keyrings/unifi-repo.gpg] https://www.ui.com/downloads/unifi/debian stable ubiquiti" > /etc/apt/sources.list.d/100-unifi.list
    apt-get update && apt-get install -y openjdk-8-jre-headless unifi
    systemctl start unifi
  '
}

# Показване на информация
show_info() {
  clear
  IP=$(pct exec $CTID ip -4 -o addr show eth0 | awk '{print $4}' | cut -d'/' -f1)
  
  echo "=============================================="
  echo " Инсталацията завърши успешно!"
  echo "=============================================="
  echo " UniFi Controller: https://$IP:8443"
  echo " Потребител: admin"
  echo " Парола: $PASSWORD"
  echo " Storage: $STORAGE"
  echo " Контейнер ID: $CTID"
  echo "=============================================="
  echo " Забележка: Може да отнеме 2-3 минути"
  echo " докато услугата се стартира напълно."
  echo "=============================================="
}

# Главна функция
main() {
  select_storage
  create_container
  install_unifi
  show_info
}

main
