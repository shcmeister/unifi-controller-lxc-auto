#!/bin/bash

# --- Лог функция ---
log() {
    echo "--- $(date '+%Y-%m-%d %H:%M:%S') --- $1"
}

# --- Избор на най-добър storage ---
get_best_storage() {
    pvesm status --bytes | awk '
    BEGIN {best=""; maxfree=0}
    NR>1 {
        storage=$1
        type=$2
        avail=$6
        if (type ~ /dir|lvmthin|zfspool/ && storage !~ /iso|backup/) {
            if (avail > maxfree) {
                maxfree=avail
                best=storage
            }
        }
    }
    END {if (best=="") exit 1; else print best}
    '
}

# --- Начало ---
log "Стартиране на инсталация на UniFi LXC контейнер"

log "Намиране на storage с най-много свободно място..."
BEST_STORAGE=$(get_best_storage)

if [ $? -ne 0 ] || [ -z "$BEST_STORAGE" ]; then
    log "Грешка: Не е намерен подходящ storage с достатъчно място."
    exit 1
fi

log "Избран storage: $BEST_STORAGE"

CTID=107
TEMPLATE="local:vztmpl/debian-11-standard_11.7-1_amd64.tar.zst"
DISK_SIZE=8G
MEMORY=1024
CPUS=1
ROOT_PASS="UniFiRoot123!"

# Проверка за шаблон
if ! pveam list local | grep -q debian-11; then
    log "Шаблонът не е наличен. Сваляне..."
    pveam download local debian-11-standard_11.7-1_amd64.tar.zst
fi

# Създаване на LXC
log "Създаване на LXC контейнер $CTID..."
pct create $CTID $TEMPLATE \
    -storage $BEST_STORAGE \
    -rootfs $BEST_STORAGE:$DISK_SIZE \
    -memory $MEMORY \
    -cores $CPUS \
    -hostname unifi-lxc \
    -net0 name=eth0,bridge=vmbr0,ip=dhcp \
    -features nesting=1

pct start $CTID
sleep 5

log "Задаване на root парола..."
pct exec $CTID -- bash -c "echo 'root:$ROOT_PASS' | chpasswd"

log "Инсталация на UniFi контролер..."
pct exec $CTID -- bash -c "
apt update &&
apt install -y ca-certificates curl gnupg &&
curl -fsSL https://dl.ui.com/unifi/unifi-repo.gpg | gpg --dearmor -o /usr/share/keyrings/unifi-archive-keyring.gpg &&
echo 'deb [signed-by=/usr/share/keyrings/unifi-archive-keyring.gpg] https://www.ui.com/downloads/unifi/debian stable ubiquiti' > /etc/apt/sources.list.d/100-ubnt-unifi.list &&
apt update &&
apt install -y unifi
"

# Извличане на IP
IP=$(pct exec $CTID -- hostname -I | awk '{print $1}')

log "Инсталацията приключи успешно!"
echo "=========================================="
echo " UniFi LXC Контейнер: $CTID"
echo " IP адрес: $IP"
echo " Потребител: root"
echo " Парола: $ROOT_PASS"
echo "=========================================="
