#!/bin/bash

set -e

# --- –ö–æ–Ω—Ñ–∏–≥ ---
CTID=200
HOSTNAME="unifi-lxc"
PASSWORD="YourSecurePass123"  # —Å–º–µ–Ω–∏ —Å —Ç–≤–æ—è –ø–∞—Ä–æ–ª–∞
CORES=2
MEMORY=4096
DISK=18

# --- –§—É–Ω–∫—Ü–∏–∏ –∑–∞ —Å—ä–æ–±—â–µ–Ω–∏—è ---
error_msg() { echo -e "\e[31m‚ùå $1\e[0m"; }
success_msg() { echo -e "\e[32m‚úÖ $1\e[0m"; }
info_msg() { echo -e "\e[34m‚ÑπÔ∏è $1\e[0m"; }

# --- –ò–∑–±–∏—Ä–∞ storage ---
STORAGE=$(pvesm status | awk 'NR>1 {print $1}' | head -n1)
if [ -z "$STORAGE" ]; then
  error_msg "–ù—è–º–∞ –æ—Ç–∫—Ä–∏—Ç storage –≤ Proxmox. –î–æ–±–∞–≤–∏ –ø–æ–Ω–µ –µ–¥–∏–Ω –∏ –ø—Ä–æ–±–≤–∞–π –ø–∞–∫."
  exit 1
fi
info_msg "–ò–∑–±—Ä–∞–Ω storage: $STORAGE"

# --- –ò–∑–±–∏—Ä–∞ Debian 12 template ---
TEMPLATE=$(pveam available | grep debian-12-standard | head -n1)
if [ -z "$TEMPLATE" ]; then
  error_msg "–ù–µ –Ω–∞–º–µ—Ä–∏—Ö Debian 12 template –∑–∞ —Å–≤–∞–ª—è–Ω–µ."
  exit 1
fi
info_msg "–ò–∑–±—Ä–∞–Ω template: $TEMPLATE"

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–≤–∞–ª—è–Ω–µ –Ω–∞ template ---
if ! pveam list $STORAGE | grep -q "$TEMPLATE"; then
  info_msg "–°–≤–∞–ª—è–Ω–µ –Ω–∞ template $TEMPLATE..."
  pveam download $STORAGE $TEMPLATE
else
  success_msg "Template $TEMPLATE –≤–µ—á–µ –µ –Ω–∞–ª–∏—á–µ–Ω."
fi

# --- –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---
info_msg "–°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ LXC —Å ID $CTID..."
pct create $CTID $STORAGE:vztmpl/$TEMPLATE \
  --hostname $HOSTNAME \
  --cores $CORES \
  --memory $MEMORY \
  --rootfs ${STORAGE}:${DISK} \
  --password $PASSWORD \
  --features nesting=1 \
  --net0 name=eth0,bridge=vmbr0,ip=dhcp \
  --ostype debian \
  --onboot 1

# --- –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---
info_msg "–°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
pct start $CTID

# --- –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è UniFi Controller ---
info_msg "–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ UniFi Controller –≤—ä—Ç—Ä–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
pct exec $CTID -- bash -c "
apt-get update && \
apt-get install -y curl gnupg apt-transport-https wget lsb-release ca-certificates openjdk-17-jre-headless && \
wget -qO - https://dl.ui.com/unifi/unifi-repo.gpg | gpg --dearmor -o /usr/share/keyrings/unifi-archive-keyring.gpg && \
echo 'deb [signed-by=/usr/share/keyrings/unifi-archive-keyring.gpg] https://dl.ui.com/unifi/debian stable ubiquiti' > /etc/apt/sources.list.d/unifi.list && \
wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-archive-keyring.gpg && \
echo 'deb [signed-by=/usr/share/keyrings/mongodb-archive-keyring.gpg] http://repo.mongodb.org/apt/debian bookworm/mongodb-org/7.0 main' > /etc/apt/sources.list.d/mongodb.list && \
apt-get update && \
apt-get install -y unifi && \
systemctl enable --now unifi
"

# --- –í–∑–µ–º–∞–Ω–µ –Ω–∞ IP ---
info_msg "–ò–∑—á–∞–∫–≤–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∞ –ø–æ–ª—É—á–∏ IP..."
sleep 10
IP=$(pct exec $CTID -- hostname -I | awk '{print $1}')

if [ -z "$IP" ]; then
  error_msg "–ù–µ —É—Å–ø—è—Ö –¥–∞ –≤–∑–µ–º–∞ IP –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä–∏ DHCP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ."
else
  success_msg "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ä—Ç —Ä–∞–±–æ—Ç–∏ —Å IP: $IP"
  echo -e "\e[1;36müåê –î–æ—Å—Ç—ä–ø –¥–æ UniFi Controller: https://$IP:8443\e[0m"
fi

success_msg "üéâ –í—Å–∏—á–∫–æ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ –∏ UniFi Controller —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏."
