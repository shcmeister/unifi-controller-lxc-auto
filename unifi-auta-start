#!/bin/bash
set -euo pipefail

# --- Config ---
CTID=200
HOSTNAME="unifi-lxc"
PASSWORD=""
TEMPLATE_NAME="debian-12-standard_12.7-1_amd64.tar.zst"
CORES=2
MEMORY=4096
DISK=18

# –¶–≤–µ—Ç–æ–≤–µ –∑–∞ –∏–∑—Ö–æ–¥
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # –ë–µ–∑ —Ü–≤—è—Ç

# –§—É–Ω–∫—Ü–∏–∏
error_exit() {
    echo -e "${RED}‚ùå ERROR: $1${NC}"
    exit 1
}

success_msg() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

info_msg() {
    echo -e "${CYAN}‚ÑπÔ∏è $1${NC}"
}

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç—ä—Ç –µ –ø—É—Å–Ω–∞—Ç –∫–∞—Ç–æ root ---
if [[ $EUID -ne 0 ]]; then
   error_exit "–¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞—à —Å–∫—Ä–∏–ø—Ç–∞ –∫–∞—Ç–æ root –∏–ª–∏ —Å sudo."
fi

# --- –í—ä–ø—Ä–æ—Å–∏ –∫—ä–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è ---
echo "–ù–∞–ª–∏—á–Ω–∏ —Å—Ç–æ—Ä–∏–¥–∂–∏ –≤ —Å–∏—Å—Ç–µ–º–∞—Ç–∞:"
pvesm status | awk 'NR>1 {print "- "$1}'

read -rp "–ò–∑–±–µ—Ä–∏ —Å—Ç–æ—Ä–∏–¥–∂ –∑–∞ —à–∞–±–ª–æ–Ω–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ local): " TEMPLATE_STORAGE
read -rp "–ò–∑–±–µ—Ä–∏ —Å—Ç–æ—Ä–∏–¥–∂ –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (rootfs) (–ø—Ä–∏–º–µ—Ä–Ω–æ local-lvm): " ROOTFS_STORAGE
read -rp "–í—ä–≤–µ–¥–∏ CTID (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 200): " CTID
read -rp "–í—ä–≤–µ–¥–∏ hostname –∑–∞ LXC (–ø—Ä–∏–º–µ—Ä–Ω–æ unifi-lxc): " HOSTNAME
read -rsp "–í—ä–≤–µ–¥–∏ –ø–∞—Ä–æ–ª–∞ –∑–∞ root –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: " PASSWORD
echo ""

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–≤–∞–ª—è–Ω–µ –Ω–∞ template ---
info_msg "–ü—Ä–æ–≤–µ—Ä—è–≤–∞–º –¥–∞–ª–∏ —à–∞–±–ª–æ–Ω—ä—Ç $TEMPLATE_NAME –µ –Ω–∞–ª–∏—á–µ–Ω –≤ $TEMPLATE_STORAGE..."
if ! pveam list $TEMPLATE_STORAGE | grep -q "$TEMPLATE_NAME"; then
    info_msg "–®–∞–±–ª–æ–Ω—ä—Ç –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω. –°–≤–∞–ª—è–º..."
    pveam download $TEMPLATE_STORAGE $TEMPLATE_NAME || error_exit "–ù–µ—É—Å–ø–µ—à–Ω–æ —Å–≤–∞–ª—è–Ω–µ –Ω–∞ —à–∞–±–ª–æ–Ω–∞!"
else
    success_msg "–®–∞–±–ª–æ–Ω—ä—Ç –≤–µ—á–µ –µ –Ω–∞–ª–∏—á–µ–Ω."
fi

# --- –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---
info_msg "–°—ä–∑–¥–∞–≤–∞–º LXC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CTID —Å hostname $HOSTNAME..."
pct create $CTID $TEMPLATE_STORAGE:vztmpl/$TEMPLATE_NAME \
  --hostname $HOSTNAME \
  --cores $CORES \
  --memory $MEMORY \
  --rootfs ${ROOTFS_STORAGE}:${DISK} \
  --password $PASSWORD \
  --features nesting=1 \
  --net0 name=eth0,bridge=vmbr0,ip=dhcp \
  --ostype debian || error_exit "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—ä–∑–¥–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"

# --- –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---
info_msg "–°—Ç–∞—Ä—Ç–∏—Ä–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
pct start $CTID || error_exit "–ù–µ—É—Å–ø–µ—à–µ–Ω —Å—Ç–∞—Ä—Ç –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"

# --- –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ UniFi Controller –≤—ä—Ç—Ä–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---

info_msg "–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–º UniFi Controller –≤—ä—Ç—Ä–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

pct exec $CTID -- bash -c "bash -s" <<'EOF'
#!/bin/bash
set -e

log() {
    echo "[UniFi Install] $(date +'%Y-%m-%d %H:%M:%S') $1"
}

log "–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞..."
apt-get update && apt-get upgrade -y

log "–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
apt-get install -y curl gnupg apt-transport-https wget lsb-release ca-certificates openjdk-17-jre-headless

log "–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ UniFi —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –∫–ª—é—á–æ–≤–µ..."
wget -qO - https://dl.ui.com/unifi/unifi-repo.gpg | apt-key add -
echo 'deb https://dl.ui.com/unifi/debian stable ubiquiti' > /etc/apt/sources.list.d/100-ubnt-unifi.list

log "–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ MongoDB 7.0 —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –∫–ª—é—á–æ–≤–µ..."
wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | apt-key add -
DEBIAN_CODENAME=$(lsb_release -cs)
echo "deb http://repo.mongodb.org/apt/debian $DEBIAN_CODENAME/mongodb-org/7.0 main" > /etc/apt/sources.list.d/mongodb-org-7.0.list

log "–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –ø–∞–∫–µ—Ç–∏—Ç–µ..."
apt-get update

log "–ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ UniFi Controller..."
apt-get install -y unifi

log "–°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ UniFi —É—Å–ª—É–≥–∞—Ç–∞..."
systemctl enable unifi
systemctl start unifi

log "–ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è—Ç–∞ –ø—Ä–∏–∫–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ!"
EOF

# --- –ò–∑—á–∞–∫–≤–∞–Ω–µ –¥–∞ –ø—É—Å–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –¥–∞ –ø–æ–ª—É—á–∏ IP ---
info_msg "–ò–∑—á–∞–∫–≤–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ –∏ –¥–∞ –ø–æ–ª—É—á–∏ IP –∞–¥—Ä–µ—Å..."

sleep 10

CONTAINER_IP=$(pct exec $CTID -- hostname -I | awk '{print $1}')
if [[ -z "$CONTAINER_IP" ]]; then
    error_exit "–ù–µ—É—Å–ø—è—Ö –¥–∞ –≤–∑–µ–º–∞ IP –∞–¥—Ä–µ—Å–∞ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞."
fi

# --- –§–∏–Ω–∞–ª–µ–Ω —Å—Ç–∞—Ç—É—Å ---
echo -e "\n${GREEN}üéâ –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è—Ç–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
echo -e "${CYAN}üëâ UniFi Controller –µ –¥–æ—Å—Ç—ä–ø–µ–Ω –Ω–∞ —Å–ª–µ–¥–Ω–∏—è –∞–¥—Ä–µ—Å:${NC}"
echo -e "${GREEN}https://${CONTAINER_IP}:8443${NC}"
echo -e "${CYAN}–£–≤–µ—Ä–∏ —Å–µ, —á–µ –ø–æ—Ä—Ç 8443 –µ –æ—Ç–≤–æ—Ä–µ–Ω –≤—ä–≤ firewall-–∞.${NC}"
echo -e "${GREEN}–ó–∞ —Å—Ç–∞—Ç—É—Å –Ω–∞ —É—Å–ª—É–≥–∞—Ç–∞ –≤—ä—Ç—Ä–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–∑–ø–æ–ª–∑–≤–∞–π:${NC} pct exec $CTID -- systemctl status unifi"
echo -e "${GREEN}–ó–∞ –ª–æ–≥–æ–≤–µ:${NC} pct exec $CTID -- tail -f /var/log/unifi/server.log"
echo ""

exit 0
